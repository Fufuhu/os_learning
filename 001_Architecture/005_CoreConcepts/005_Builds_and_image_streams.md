# Builds
インプットとなるパラメータやソースコードを実行可能なイメージに変換するプロセスのことである。
BuildConfigオブジェクトでビルドのプロセエス全体を定義する。

Openshiftコンテナプラットフォームでは、Dockerコンテナをビルドし、コンテナレジストリに
プッシュすることでKubenetesを最大限利用する。

主なビルド手段は3つある。

1. Docker Build
1. Source-to-Image(S2I) Build
1. Custom build

デフォルトではDockerBuildとS2I buildがサポートされている。
さらにPipelineビルドではさらに洗練されたワークフローを実装することができ、
CI/CDを実現することができる。
詳細はOpenshiftのdevelopers guideを参照

https://docs.openshift.com/container-platform/3.3/dev_guide/builds.html#dev-guide-build

## Docker Builds
docker buildコマンドを用いた方法。
Docker buildコマンドとデプロイするファイル群があればOK

## Source-to-Image(S2I) Builds
Source-to-Imageは再現可能なDockerコンテナイメージをビルドするためのツールである。
アプリケーションソースをコンテナに挿入することで、新しいイメージを構築し、
実行準備が完了しているイメージを作成できる。

新しいイメージはベースイメージを組み込み(Builder)、ソースをビルドし、docker runで利用可能な状態にする。
S2Iはインクリメンタルなビルドをサポートしており、過去にダウンロードした依存関係ファイルや、過去にビルドした成果物などを
再利用することができる。

S2Iビルドの利点は以下の２つある。

1. Imageの柔軟性
    - S2Iスクリプトは既存のコンテナイメージに対してアプリケーションコードを挿入することで、既存のエコシステムの利点を取り入れつつ、
    記述することができる。このことから現在ではS2Iはアプリケーションソースをインジェクトする際に、
    tarに依存していることは注意すること。(イメージはtarを処理できなければならない)
1. 速度
    - S2Iを使うことで個々のステップにおいて新しいレイヤーを作ることなく複雑かつ膨大な数の操作を実現することができるので、
    ビルドの速度は早い。さらに、S2Iスクリプトでは古いバージョンのアプリケーションイメージに含まれるアーティファクトを再利用することができるので、
    速度が早い
1. パッチしやすい
    - S2Iによって、セキュリティイシューなどにともなってパッチを付与後に、
    アプリケーション全体をリビルドすることができる。
1. 操作効率
    - ビルド操作の内容をDockerfileで許されている範囲に制限することで、
    PaaSオペレータは偶然または意図したビルドシステムの不適切利用を回避することができる。
1. オペレーションセキュリティ
    - 任意のDockerfileではルート権限昇格の可能性をはらんでいる。
    root権限外のユーザプロセスとしてDocker buildを実行することでセキュリティを改善する。
1. ユーザ効率の向上
    - S2Iは、任意のyum install型の操作を禁止することで、開発のイテレーションの速度低下を
    避けることができる。
1. エコシステム
    - S2Iでは、ベストプラクティスを含んだイメージを自身のアプリケーションに流用することができる。
1. 再生産性 
    - 作成されたイメージは特定のバージョンのビルドツールや依存関係をすべて含んでいる。
    これによってイメージは完全に再生産可能である。

## Custom Builds
いろいろめんどくさいことしなきゃいけないよ〜。

## Pipeline Build
Jenkinsパイプラインを定義してビルドを実行する。
Jenkinsfileに記述するか、ビルド設定に埋め込んでしまうか、Gitリポジトリを参照するよう
ビルド設定に記述するかで実現できる。
初回実行時にJenkinsインスタンスが起動されるので注意ね。

# Image Streams

端的に述べると特定の環境の中で利用するイメージのセット。
新規イメージのビルドなどを自動検知して入れ替えるなどをやってくれる????

Image Streamは複数のDockerのコンテナイメージから構成される。
Image Sreamによってイメージリポジトリとが似通った、関連するイメージの
単一の仮想ビューが提供される。
Imageは以下のものを含む

1. Openshiftコンテナプラットフォームに統合されているレジストリ
1. 他のImage stream
1. 外部レジストリのイメージリポジトリ

たとえば、特定のイメージがデプロイ内部で利用されており、イメージの新しいバージョンが作成されたとき、
デプロイが自動で実行されるなどを実現することができる。

詳細はDevelopers guide参照
- https://docs.openshift.com/container-platform/3.3/dev_guide/managing_images.html#dev-guide-managing-images

## Image Stream Mappings
組み込みレジストリが新しいイメージを受け取ったとき、それはImageStreamMappingをプラットフォーム側に送信する。
ImageStreamMappingには、イメージの所属するプロジェクト、タグ、そしてイメージのメタデータを含んでいる。

この情報はイメージが存在しない場合には、新しいイメージの作成に利用される。また、イメージをImage Streamに対して
タグ付けする。Openshiftコンテナプラットフォームは個々のイメージのメタデータを保存している。
メタデータにはコマンドや、エントリーポイント、環境変数といった情報を含んでいる。
Openshiftコンテナプラットフォーム内のイメージ名は、普遍かつ、最大63文字である。